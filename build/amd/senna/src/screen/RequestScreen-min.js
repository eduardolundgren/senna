define(["exports","metal/src/metal","../errors/errors","../utils/utils","../globals/globals","./Screen","metal-uri/src/Uri"],function(e,t,r,a,o,n,u){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var d=i(r),c=i(a),h=i(o),p=i(n),m=i(u),y=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),v=function(e){function r(){s(this,r);var e=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.cacheable=!0,e.httpHeaders={"X-PJAX":"true","X-Requested-With":"XMLHttpRequest"},e.httpMethod=r.GET,e.request=null,e.timeout=3e4,e}return f(r,e),y(r,[{key:"assertValidResponseStatusCode",value:function(e){if(!this.isValidResponseStatusCode(e)){var t=new Error(d["default"].INVALID_STATUS);throw t.invalidStatus=!0,t.statusCode=e,t}}},{key:"beforeUpdateHistoryPath",value:function(e){var t=this.getRequestPath();return t&&t!==e?t:e}},{key:"beforeUpdateHistoryState",value:function(e){return e.senna&&e.form&&e.redirectPath===e.path?null:e}},{key:"formatLoadPath",value:function(e){var t=new m["default"](e);return t.setHostname(h["default"].window.location.hostname),t.setProtocol(h["default"].window.location.protocol),h["default"].window.location.port&&t.setPort(h["default"].window.location.port),c["default"].isIeOrEdge()&&this.httpMethod===r.GET?t.makeUnique().toString():t.toString()}},{key:"getHttpHeaders",value:function(){return this.httpHeaders}},{key:"getHttpMethod",value:function(){return this.httpMethod}},{key:"getRequestPath",value:function(){var e=this.getRequest();if(e){var t=e.url,a=this.maybeExtractResponseUrlFromRequest(e);return a&&(t=a),c["default"].isIeOrEdge()&&this.httpMethod===r.GET&&(t=new m["default"](t).removeUnique().toString()),c["default"].getUrlPath(t)}return null}},{key:"getRequest",value:function(){return this.request}},{key:"getTimeout",value:function(){return this.timeout}},{key:"isValidResponseStatusCode",value:function(e){return e>=200&&e<=399}},{key:"getFormData",value:function(e,t){var r=new FormData(e);return this.maybeAppendSubmitButtonValue_(r,t),r}},{key:"load",value:function(e){var a=this,o=this.getCache();if((0,t.isDefAndNotNull)(o))return Promise.resolve(o);var n=null,u=this.httpMethod,i=new Headers;Object.keys(this.httpHeaders).forEach(function(e){i.set(e,a.httpHeaders[e])}),h["default"].capturedFormElement&&(this.addSafariXHRPolyfill(),n=this.getFormData(h["default"].capturedFormElement,h["default"].capturedFormButtonElement),u=r.POST,c["default"].isIeOrEdge()&&i.append("If-None-Match",'"0"'));var s=this.formatLoadPath(e),l=new Request(s,{body:n,credentials:"include",headers:i,method:u,mode:"cors",redirect:"follow"});return this.setRequest(l),Promise.race([fetch(l).then(function(e){return a.removeSafariXHRPolyfill(),a.assertValidResponseStatusCode(e.status),e.clone().text()}).then(function(e){return u===r.GET&&a.isCacheable()&&a.addCache(e),e}),new Promise(function(e,t){setTimeout(function(){return t(new Error(d["default"].REQUEST_TIMEOUT))},a.timeout)})])["catch"](function(e){switch(a.removeSafariXHRPolyfill(),e.message){case d["default"].REQUEST_TIMEOUT:e.timeout=!0;break;case d["default"].REQUEST_ERROR:e.requestError=!0;break;case d["default"].REQUEST_PREMATURE_TERMINATION:e.requestError=!0,e.requestPrematureTermination=!0}throw e instanceof TypeError&&(e.requestError=!0,e.requestPrematureTermination=!0),e})}},{key:"maybeAppendSubmitButtonValue_",value:function(e,t){t&&t.name&&e.append(t.name,t.value)}},{key:"maybeExtractResponseUrlFromRequest",value:function(e){return e.headers.get(r.X_REQUEST_URL_HEADER)}},{key:"addSafariXHRPolyfill",value:function(){if(h["default"].capturedFormElement&&c["default"].isSafari())for(var e=h["default"].capturedFormElement.querySelectorAll('input[type="file"]:not([disabled])'),t=0;t<e.length;t++){var r=e[t];if(r.files.length>0)return;r.setAttribute("data-safari-temp-disabled","true"),r.setAttribute("disabled","")}}},{key:"removeSafariXHRPolyfill",value:function(){if(h["default"].capturedFormElement&&c["default"].isSafari())for(var e=h["default"].capturedFormElement.querySelectorAll('input[type="file"][data-safari-temp-disabled]'),t=0;t<e.length;t++){var r=e[t];r.removeAttribute("data-safari-temp-disabled"),r.removeAttribute("disabled")}}},{key:"setHttpHeaders",value:function(e){this.httpHeaders=e}},{key:"setHttpMethod",value:function(e){this.httpMethod=e.toLowerCase()}},{key:"setRequest",value:function(e){this.request=e}},{key:"setTimeout",value:function(e){this.timeout=e}}]),r}(p["default"]);v.GET="get",v.POST="post",v.X_REQUEST_URL_HEADER="X-Request-URL",e["default"]=v});